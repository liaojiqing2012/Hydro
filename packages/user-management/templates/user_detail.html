{% extends 'base.html' %}
{% block title %}用户详情{% endblock %}
{% block content %}
<div class="section">
    <div class="section__header">
        <h1 class="section__title">用户详情</h1>
        <a href="/admin/users" class="button button--secondary">返回用户列表</a>
    </div>
    <div class="section__body">
        <div class="grid">
            <div class="grid__column grid__column--6">
                <div class="card">
                    <div class="card__header">
                        <h2 class="card__title">基本信息</h2>
                    </div>
                    <div class="card__body">
                        <div class="form" id="user-info">
                            <!-- 用户信息将通过JavaScript动态加载 -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid__column grid__column--6">
                <div class="card">
                    <div class="card__header">
                        <h2 class="card__title">更新用户信息</h2>
                    </div>
                    <div class="card__body">
                        <form id="update-form" onsubmit="return updateUser(event)">
                            <div class="form__group">
                                <label class="form__label" for="home">主页</label>
                                <input type="text" class="form__input" id="home" name="home">
                            </div>
                            <div class="form__group">
                                <label class="form__label" for="permission">权限</label>
                                <select class="form__select" id="permission" name="permission">
                                    <option value="user">普通用户</option>
                                    <option value="admin">管理员</option>
                                    <option value="superadmin">超级管理员</option>
                                </select>
                            </div>
                            <div class="form__group">
                                <button type="submit" class="button button--primary">更新信息</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card">
                    <div class="card__header">
                        <h2 class="card__title">更改密码</h2>
                    </div>
                    <div class="card__body">
                        <form id="change-password-form" onsubmit="return changePassword(event)">
                            <div class="form__group">
                                <label class="form__label" for="new-password">新密码</label>
                                <input type="password" class="form__input" id="new-password" name="password" required>
                            </div>
                            <div class="form__group">
                                <button type="submit" class="button button--primary">更改密码</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 用户详情页面的JavaScript代码
    const uid = window.location.pathname.split('/').pop();
    
    async function loadUserDetail() {
        const response = await fetch(`/api/admin/users/${uid}`);
        const user = await response.json();
        
        const userInfo = document.getElementById('user-info');
        userInfo.innerHTML = `
            <div class="form__group">
                <label class="form__label">用户ID</label>
                <div class="form__text">${user._id}</div>
            </div>
            <div class="form__group">
                <label class="form__label">用户名</label>
                <div class="form__text">${user.uname}</div>
            </div>
            <div class="form__group">
                <label class="form__label">邮箱</label>
                <div class="form__text">${user.email}</div>
            </div>
            <div class="form__group">
                <label class="form__label">注册时间</label>
                <div class="form__text">${new Date(user.registerTime).toLocaleString()}</div>
            </div>
            <div class="form__group">
                <label class="form__label">上次登录</label>
                <div class="form__text">${user.lastLogin ? new Date(user.lastLogin).toLocaleString() : '从未登录'}</div>
            </div>
            <div class="form__group">
                <label class="form__label">主页</label>
                <div class="form__text">${user.home || '未设置'}</div>
            </div>
            <div class="form__group">
                <label class="form__label">权限</label>
                <div class="form__text">${user.permission}</div>
            </div>
        `;
        
        // 填充表单
        document.getElementById('home').value = user.home || '';
        document.getElementById('permission').value = user.permission;
    }
    
    async function updateUser(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);
        
        const response = await fetch(`/api/admin/users/${uid}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('用户信息更新成功');
            loadUserDetail();
        } else {
            alert('更新失败');
        }
        return false;
    }
    
    async function changePassword(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);
        
        const response = await fetch(`/api/admin/users/${uid}/change-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('密码更改成功');
            event.target.reset();
        } else {
            alert('密码更改失败');
        }
        return false;
    }
    
    // 页面加载时加载用户详情
    document.addEventListener('DOMContentLoaded', () => {
        loadUserDetail();
    });
</script>
{% endblock %}