{% extends "manage_base.html" %}
{% block manage_content %}
<div class="section">
  <div class="section__header">
    <h1 class="section__title">{{ _('user_management') }}</h1>
    <p class="section__desc">{{ _('user_management_description') }}</p>
    <div class="section__tools">
      <form class="inline" method="get" action="">
        <label class="input-group">
          <span class="input-addon">{{ _('user_management_keyword') }}</span>
          <input type="text" name="q" value="{{ keyword }}" placeholder="{{ _('user_management_keyword') }}">
        </label>
        <label class="input-group">
          <span class="input-addon">{{ _('user_management_sort_by') }}</span>
          <select name="sort">
              <option value="uid"{% if sort == 'uid' %} selected{% endif %}>{{ _('user_management_uid') }}</option>
              <option value="uname"{% if sort == 'uname' %} selected{% endif %}>{{ _('user_management_uname') }}</option>
              <option value="displayName"{% if sort == 'displayName' %} selected{% endif %}>{{ _('user_management_display_name') }}</option>
              <option value="studentId"{% if sort == 'studentId' %} selected{% endif %}>{{ _('user_management_student_id') }}</option>
              <option value="school"{% if sort == 'school' %} selected{% endif %}>{{ _('user_management_school') }}</option>
              <option value="email"{% if sort == 'email' %} selected{% endif %}>{{ _('user_management_email') }}</option>
              <option value="regat"{% if sort == 'regat' %} selected{% endif %}>{{ _('user_management_registered') }}</option>
              <option value="loginat"{% if sort == 'loginat' %} selected{% endif %}>{{ _('user_management_last_login') }}</option>
              <option value="role"{% if sort == 'role' %} selected{% endif %}>{{ _('user_management_role') }}</option>
              <option value="priv"{% if sort == 'priv' %} selected{% endif %}>{{ _('user_management_privilege') }}</option>
              <option value="loginip"{% if sort == 'loginip' %} selected{% endif %}>{{ _('user_management_last_login_ip') }}</option>
          </select>
        </label>
        <label class="input-group">
          <span class="input-addon">{{ _('user_management_sort_order') }}</span>
          <select name="order">
              <option value="asc"{% if order == 'asc' %} selected{% endif %}>{{ _('user_management_sort_asc') }}</option>
              <option value="desc"{% if order == 'desc' %} selected{% endif %}>{{ _('user_management_sort_desc') }}</option>
          </select>
        </label>
        <button class="primary rounded button" type="submit">
          <span class="icon icon-search"></span> {{ _('user_management_search') }}
        </button>
      </form>
    </div>
  </div>
  <div class="section__body no-padding">
    <table class="data-table">
      <colgroup>
        <col class="col--check">
        <col class="col--uid">
        <col class="col--user">
        <col class="col--user">
        <col class="col--student">
        <col class="col--school">
        <col class="col--mail">
        <col class="col--role">
        <col class="col--priv">
        <col class="col--date">
        <col class="col--date">
        <col class="col--ip">
        <col class="col--action">
      </colgroup>
      <thead>
        <tr>
          <th class="col--check">
            <label class="checkbox-inline">
              <input type="checkbox" id="select-all">
              <span class="checkbox"></span>
            </label>
          </th>
          <th class="col--uid">{{ _('user_management_uid') }}</th>
          <th class="col--user">{{ _('user_management_uname') }}</th>
          <th class="col--user">{{ _('user_management_display_name') }}</th>
          <th class="col--student">{{ _('user_management_student_id') }}</th>
          <th class="col--school">{{ _('user_management_school') }}</th>
          <th class="col--mail">{{ _('user_management_email') }}</th>
          <th class="col--role">{{ _('user_management_role') }}</th>
          <th class="col--priv">{{ _('user_management_privilege') }}</th>
          <th class="col--date">{{ _('user_management_registered') }}</th>
          <th class="col--date">{{ _('user_management_last_login') }}</th>
          <th class="col--ip">{{ _('user_management_last_login_ip') }}</th>
          <th class="col--action">{{ _('user_management_actions') }}</th>
        </tr>
      </thead>
      <tbody>
        {% if users.length == 0 %}
        <tr>
          <td class="col--empty" colspan="13">{{ _('user_management_empty') }}</td>
        </tr>
        {% else %}
          {% for u in users %}
          <tr>
            <td class="col--check">
              <label class="checkbox-inline">
                <input type="checkbox" name="uids" value="{{ u._id }}">
                <span class="checkbox"></span>
              </label>
            </td>
            <td class="col--uid">{{ u._id }}</td>
            <td class="col--user"><a href="{{ url('user_detail', { uid: u._id }) }}">{{ u.uname }}</a></td>
            <td class="col--user">{{ u.displayName or '-' }}</td>
            <td class="col--student">{{ u.studentId or '-' }}</td>
            <td class="col--school">{{ u.school or '-' }}</td>
            <td class="col--mail">{{ u.mail }}</td>
            <td class="col--role">{{ u.role }}</td>
            <td class="col--priv">{{ u.priv }}</td>
            <td class="col--date">{{ datetimeSpan(u.regat) | safe }}</td>
            <td class="col--date">{{ datetimeSpan(u.loginat) | safe }}</td>
            <td class="col--ip">{{ u.loginip or '-' }}</td>
            <td class="col--action">
              <div class="dropdown">
                <button class="small button dropdown-toggle" type="button">
                  {{ _('user_management_actions') }}
                </button>
                <ul class="dropdown-menu">
                  <li><a href="{{ url('user_detail', { uid: u._id }) }}"><span class="icon icon-eye"></span> {{ _('user_management_view') }}</a></li>
                  <li><a href="#" class="edit-user" data-uid="{{ u._id }}"><span class="icon icon-pencil"></span> {{ _('user_management_edit') }}</a></li>
                  <li><a href="#" class="reset-password" data-uid="{{ u._id }}"><span class="icon icon-key"></span> {{ _('user_management_reset_password') }}</a></li>
                  <li><a href="{{ url('user_domains', { uid: u._id }) }}"><span class="icon icon-domain"></span> {{ _('user_management_domains') }}</a></li>
                  <li><a href="#" class="toggle-user-status" data-uid="{{ u._id }}" data-status="{% if u.disabled %}enable{% else %}disable{% endif %}">
                    <span class="icon icon-{% if u.disabled %}check{% else %}x{% endif %}"></span> {% if u.disabled %}{{ _('user_management_enable') }}{% else %}{{ _('user_management_disable') }}{% endif %}
                  </a></li>
                  <li class="divider"></li>
                  <li class="danger"><a href="#" class="delete-user" data-uid="{{ u._id }}"><span class="icon icon-trash"></span> {{ _('user_management_delete') }}</a></li>
                </ul>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% endif %}
      </tbody>
      {% if totalPages > 1 %}
      <tfoot>
        <tr>
          <td colspan="13" class="pagination">
            <div class="row align-middle">
              <div class="columns small-6">{{ _('Page {0} / {1}', page, totalPages) }}</div>
              <div class="columns small-6 align-right">
                {% if page > 1 %}
                  <a class="button" href="{{ url('user_management', { page: page - 1, q: keyword, sort: sort, order: order }) }}">&laquo; {{ _('Prev') }}</a>
                {% endif %}
                {% if page < totalPages %}
                  <a class="button" href="{{ url('user_management', { page: page + 1, q: keyword, sort: sort, order: order }) }}">{{ _('Next') }} &raquo;</a>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>
</div>

<!-- 编辑用户模态框 -->
<div class="modal" id="edit-user-modal">
  <div class="modal-container">
    <div class="modal-header">
      <h3>{{ _('user_management_edit_user') }}</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="edit-user-form" method="post">
        <input type="hidden" name="uid" id="edit-uid">
        <div class="row">
          <div class="columns small-12">
            <label>{{ _('user_management_display_name') }}
              <input type="text" name="displayName" id="edit-displayName">
            </label>
          </div>
          <div class="columns small-12 medium-6">
            <label>{{ _('user_management_student_id') }}
              <input type="text" name="studentId" id="edit-studentId">
            </label>
          </div>
          <div class="columns small-12 medium-6">
            <label>{{ _('user_management_school') }}
              <input type="text" name="school" id="edit-school">
            </label>
          </div>
          <div class="columns small-12">
            <label>{{ _('user_management_home_page') }}
              <input type="text" name="home" id="edit-home" placeholder="https://example.com">
            </label>
          </div>
          <div class="columns small-12">
            <label>{{ _('user_management_permission') }}
              <input type="text" name="permission" id="edit-permission" placeholder="user,admin">
            </label>
            <p class="help-text">{{ _('user_management_permission_help') }}</p>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="button" data-close-modal>{{ _('Cancel') }}</button>
      <button class="primary button" id="save-user-changes">{{ _('Save Changes') }}</button>
    </div>
  </div>
</div>

<!-- 重置密码模态框 -->
<div class="modal" id="reset-password-modal">
  <div class="modal-container">
    <div class="modal-header">
      <h3>{{ _('user_management_reset_password') }}</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="reset-password-form" method="post">
        <input type="hidden" name="uid" id="reset-uid">
        <div class="row">
          <div class="columns small-12">
            <label>{{ _('user_management_new_password') }}
              <input type="password" name="password" id="new-password" placeholder="{{ _('user_management_new_password_placeholder') }}">
            </label>
          </div>
          <div class="columns small-12">
            <label>{{ _('user_management_confirm_password') }}
              <input type="password" name="confirmPassword" id="confirm-password" placeholder="{{ _('user_management_confirm_password_placeholder') }}">
            </label>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="button" data-close-modal>{{ _('Cancel') }}</button>
      <button class="primary button" id="confirm-reset-password">{{ _('Reset Password') }}</button>
    </div>
  </div>
</div>

<!-- 批量操作工具栏 -->
<div class="section">
  <div class="section__body">
    <div class="row">
      <div class="columns small-12">
        <div class="batch-actions">
          <button class="button" id="batch-delete"><span class="icon icon-trash"></span> {{ _('user_management_batch_delete') }}</button>
          <button class="button" id="batch-enable"><span class="icon icon-check"></span> {{ _('user_management_batch_enable') }}</button>
          <button class="button" id="batch-disable"><span class="icon icon-x"></span> {{ _('user_management_batch_disable') }}</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 全选/取消全选
    document.getElementById('select-all').addEventListener('change', function(e) {
      const checkboxes = document.querySelectorAll('input[name="uids"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
      });
    });
    
    // 编辑用户
    document.querySelectorAll('.edit-user').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const uid = this.dataset.uid;
        // 这里可以通过AJAX获取用户信息并填充表单
        document.getElementById('edit-uid').value = uid;
        document.getElementById('edit-user-modal').classList.add('active');
      });
    });
    
    // 重置密码
    document.querySelectorAll('.reset-password').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const uid = this.dataset.uid;
        document.getElementById('reset-uid').value = uid;
        document.getElementById('reset-password-modal').classList.add('active');
      });
    });
    
    // 切换用户状态
    document.querySelectorAll('.toggle-user-status').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const uid = this.dataset.uid;
        const status = this.dataset.status;
        if (confirm(status === 'disable' ? '{{ _('user_management_confirm_disable') }}' : '{{ _('user_management_confirm_enable') }}')) {
          // 这里可以通过AJAX切换用户状态
          location.reload();
        }
      });
    });
    
    // 删除用户
    document.querySelectorAll('.delete-user').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const uid = this.dataset.uid;
        if (confirm('{{ _('user_management_confirm_delete') }}')) {
          // 这里可以通过AJAX删除用户
          location.reload();
        }
      });
    });
    
    // 保存用户编辑
    document.getElementById('save-user-changes').addEventListener('click', function() {
      // 这里可以通过AJAX保存用户信息
      document.getElementById('edit-user-modal').classList.remove('active');
      location.reload();
    });
    
    // 确认重置密码
    document.getElementById('confirm-reset-password').addEventListener('click', function() {
      const password = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      if (password !== confirmPassword) {
        alert('{{ _('user_management_password_mismatch') }}');
        return;
      }
      // 这里可以通过AJAX重置密码
      document.getElementById('reset-password-modal').classList.remove('active');
      location.reload();
    });
    
    // 批量删除
    document.getElementById('batch-delete').addEventListener('click', function() {
      const selectedUids = Array.from(document.querySelectorAll('input[name="uids"]:checked')).map(checkbox => checkbox.value);
      if (selectedUids.length === 0) {
        alert('{{ _('user_management_select_users') }}');
        return;
      }
      if (confirm('{{ _('user_management_confirm_batch_delete') }}')) {
        // 这里可以通过AJAX批量删除用户
        location.reload();
      }
    });
    
    // 批量启用
    document.getElementById('batch-enable').addEventListener('click', function() {
      const selectedUids = Array.from(document.querySelectorAll('input[name="uids"]:checked')).map(checkbox => checkbox.value);
      if (selectedUids.length === 0) {
        alert('{{ _('user_management_select_users') }}');
        return;
      }
      // 这里可以通过AJAX批量启用用户
      location.reload();
    });
    
    // 批量禁用
    document.getElementById('batch-disable').addEventListener('click', function() {
      const selectedUids = Array.from(document.querySelectorAll('input[name="uids"]:checked')).map(checkbox => checkbox.value);
      if (selectedUids.length === 0) {
        alert('{{ _('user_management_select_users') }}');
        return;
      }
      // 这里可以通过AJAX批量禁用用户
      location.reload();
    });
    
    // 关闭模态框
    document.querySelectorAll('[data-close-modal]').forEach(button => {
      button.addEventListener('click', function() {
        const modal = this.closest('.modal');
        modal.classList.remove('active');
      });
    });
    
    // 点击模态框外部关闭
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });
  });
</script>
{% endblock %}