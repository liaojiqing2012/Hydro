{% extends "manage_base.html" %}
{% block manage_content %}
<style>
/* 用户管理界面美化样式 - 适应900px宽度 */
.user-management {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding: 16px;
    box-sizing: border-box;
}

/* 头部样式 */
.section__header {
    margin-bottom: 16px;
    text-align: center;
}

.section__title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #2c3e50;
}

.section__desc {
    color: #7f8c8d;
    margin-bottom: 16px;
    font-size: 14px;
}

/* 搜索区域样式 */
.section__tools {
    background-color: #f8f9fa;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 16px;
    border: 1px solid #e9ecef;
    overflow-x: auto;
}

.section__tools form {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
}

.input-group {
    margin: 4px 0;
    flex: 1;
    min-width: 150px;
}

.input-group input,
.input-group select {
    width: 100%;
    box-sizing: border-box;
}

/* 表格样式 */
.section__body {
    overflow-x: auto;
    margin-bottom: 16px;
}

.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    font-size: 14px;
    min-width: 700px;
}

.data-table th {
    background-color: #f8f9fa;
    color: #495057;
    font-weight: 600;
    text-align: left;
    padding: 8px 12px;
    border-bottom: 2px solid #e9ecef;
    white-space: nowrap;
    font-size: 13px;
}

.data-table td {
    padding: 8px 12px;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
    font-size: 13px;
}

.data-table tr:hover {
    background-color: #f8f9fa;
    transition: background-color 0.2s ease;
}

.data-table tr:last-child td {
    border-bottom: none;
}

/* 调整列宽 */
.col--uid,
.col--check {
    width: 60px;
}

.col--user {
    width: 120px;
}

.col--student,
.col--school,
.col--role,
.col--priv {
    width: 80px;
}

.col--mail {
    width: 150px;
}

.col--date,
.col--ip {
    width: 100px;
}

.col--action {
    width: 80px;
    text-align: center;
}

/* 分页样式 */
.pagination {
    background-color: #f8f9fa;
    padding: 12px;
    border-radius: 0 0 8px 8px;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
}

/* 按钮样式 */
.button {
    border-radius: 6px;
    transition: all 0.2s ease;
    font-weight: 500;
    font-size: 13px;
    padding: 6px 12px;
    margin: 2px 0;
}

.button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.primary.button {
    background-color: #007bff;
    border-color: #007bff;
}

.primary.button:hover {
    background-color: #0056b3;
    border-color: #0056b3;
}

/* 下拉菜单样式 */
.dropdown {
    display: inline-block;
}

.dropdown-menu {
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border: 1px solid #e9ecef;
    min-width: 120px;
}

.dropdown-menu li a {
    padding: 6px 12px;
    transition: background-color 0.2s ease;
    font-size: 13px;
}

.dropdown-menu li a:hover {
    background-color: #f8f9fa;
    color: #007bff;
}

/* 模态框样式 */
.modal-container {
    border-radius: 8px;
    overflow: hidden;
    max-width: 500px;
    margin: 0 auto;
}

.modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    padding: 12px 16px;
}

.modal-body {
    padding: 16px;
}

.modal-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #e9ecef;
    padding: 12px 16px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

/* 表单样式 */
label {
    font-weight: 500;
    margin-bottom: 6px;
    display: block;
    font-size: 14px;
}

input[type="text"],
input[type="password"],
select {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 8px 12px;
    transition: border-color 0.2s ease;
    width: 100%;
    box-sizing: border-box;
    font-size: 14px;
}

input[type="text"]:focus,
input[type="password"]:focus,
select:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

/* 批量操作工具栏 */
.batch-actions {
    background-color: #f8f9fa;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    margin-top: 16px;
    text-align: center;
    overflow-x: auto;
}

.batch-actions .button {
    margin-right: 8px;
    margin-bottom: 8px;
}

/* 状态标签样式 */
.status-badge {
    display: inline-block;
    padding: 3px 6px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
}

.status-active {
    background-color: #d4edda;
    color: #155724;
}

.status-inactive {
    background-color: #f8d7da;
    color: #721c24;
}

/* 权限标签样式 */
.privilege-badge {
    display: inline-block;
    padding: 3px 6px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
    background-color: #e3f2fd;
    color: #1565c0;
}

/* 响应式调整 */
@media (max-width: 900px) {
    .user-management {
        padding: 8px;
    }
    
    .section__title {
        font-size: 18px;
    }
    
    .section__desc {
        font-size: 13px;
    }
    
    .section__tools form {
        flex-direction: column;
        align-items: stretch;
    }
    
    .input-group {
        width: 100%;
        min-width: auto;
    }
    
    .data-table {
        font-size: 12px;
    }
    
    .data-table th,
    .data-table td {
        padding: 6px 8px;
    }
    
    .button {
        font-size: 12px;
        padding: 5px 10px;
    }
    
    .pagination {
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    
    .pagination > div {
        text-align: center;
    }
}
</style>
<div class="user-management">
<div class="section">
  <div class="section__header">
    <h1 class="section__title">用户管理</h1>
    <p class="section__desc">管理系统用户账户和权限</p>
    <div class="section__tools">
      <form class="inline" method="get" action="">
        <label class="input-group">
          <span class="input-addon">关键词</span>
          <input type="text" name="search" value="{{ search }}" placeholder="关键词">
        </label>
        <label class="input-group">
          <span class="input-addon">排序方式</span>
          <select name="sort">
              <option value="_id"{% if sort == '_id' %} selected{% endif %}>用户ID</option>
              <option value="uname"{% if sort == 'uname' %} selected{% endif %}>用户名</option>
              <option value="regat"{% if sort == 'regat' %} selected{% endif %}>注册时间</option>
              <option value="loginat"{% if sort == 'loginat' %} selected{% endif %}>最后登录</option>
              <option value="priv"{% if sort == 'priv' %} selected{% endif %}>权限</option>
          </select>
        </label>
        <button class="primary rounded button" type="submit">
          <span class="icon icon-search"></span> 搜索
        </button>
      </form>
    </div>
  </div>
  <div class="section__body no-padding">
    <table class="data-table">
      <colgroup>
        <col class="col--check">
        <col class="col--uid">
        <col class="col--user">
        <col class="col--user">
        <col class="col--student">
        <col class="col--school">
        <col class="col--mail">
        <col class="col--role">
        <col class="col--priv">
        <col class="col--date">
        <col class="col--date">
        <col class="col--ip">
        <col class="col--action">
      </colgroup>
      <thead>
        <tr>
          <th class="col--check">
            <label class="checkbox-inline">
              <input type="checkbox" id="select-all">
              <span class="checkbox"></span>
            </label>
          </th>
          <th class="col--uid">用户ID</th>
          <th class="col--user">用户名</th>
          <th class="col--user">显示名称</th>
          <th class="col--student">学号</th>
          <th class="col--school">学校</th>
          <th class="col--mail">邮箱</th>
          <th class="col--role">角色</th>
          <th class="col--priv">权限</th>
          <th class="col--date">注册时间</th>
          <th class="col--date">最后登录</th>
          <th class="col--ip">最后登录IP</th>
          <th class="col--action">操作</th>
        </tr>
      </thead>
      <tbody>
        {% if udocs.length == 0 %}
        <tr>
          <td class="col--empty" colspan="13">暂无用户</td>
        </tr>
        {% else %}
          {% for udoc in udocs %}
          {% set dudoc = dudocMap[udoc._id] %}
          <tr>
            <td class="col--check">
              <label class="checkbox-inline">
                <input type="checkbox" name="uids" value="{{ udoc._id }}">
                <span class="checkbox"></span>
              </label>
            </td>
            <td class="col--uid">{{ udoc._id }}</td>
            <td class="col--user"><a href="{{ url('user_detail', { uid: udoc._id }) }}">{{ udoc.uname }}</a></td>
            <td class="col--user">{{ udoc.displayName or '-' }}</td>
            <td class="col--student">{{ udoc.studentId or '-' }}</td>
            <td class="col--school">{{ udoc.school or '-' }}</td>
            <td class="col--mail">{{ udoc.mail }}</td>
            <td class="col--role">{{ dudoc?.role or '-' }}</td>
            <td class="col--priv">{{ udoc.priv }}</td>
            <td class="col--date">{{ datetimeSpan(udoc.regat) | safe }}</td>
            <td class="col--date">{{ datetimeSpan(udoc.loginat) | safe }}</td>
            <td class="col--ip">{{ udoc.loginip or '-' }}</td>
            <td class="col--action">
              <div class="dropdown">
                <button class="small button dropdown-toggle" type="button">
                  操作
                </button>
                <ul class="dropdown-menu">
                  <li><a href="{{ url('user_management_detail', { uid: udoc._id }) }}"><span class="icon icon-eye"></span> 查看</a></li>
                  <li><a href="#" class="edit-user" data-uid="{{ udoc._id }}"><span class="icon icon-pencil"></span> 编辑</a></li>
                  <li><a href="#" class="reset-password" data-uid="{{ udoc._id }}"><span class="icon icon-key"></span> 重置密码</a></li>
                  <li><a href="{{ url('user_domains', { uid: udoc._id }) }}"><span class="icon icon-domain"></span> 域权限</a></li>
                  <li><a href="#" class="toggle-user-status" data-uid="{{ udoc._id }}" data-status="{% if udoc.priv == 0 %}enable{% else %}disable{% endif %}">
                    <span class="icon icon-{% if udoc.priv == 0 %}check{% else %}x{% endif %}"></span> {% if udoc.priv == 0 %}启用{% else %}禁用{% endif %}
                  </a></li>
                  <li class="divider"></li>
                  <li class="danger"><a href="#" class="ban-user" data-uid="{{ udoc._id }}"><span class="icon icon-trash"></span> 封禁</a></li>
                </ul>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% endif %}
      </tbody>
      {% if upcount > limit %}
      <tfoot>
        <tr>
          <td colspan="13" class="pagination">
            <div class="row align-middle">
              <div class="columns small-6">第 {{ page }} 页 / 共 {{ Math.ceil(upcount / limit) }} 页</div>
              <div class="columns small-6 align-right">
                {% if page > 1 %}
                  <a class="button" href="{{ url('user_management', { page: page - 1, search: search, sort: sort }) }}">&laquo; 上一页</a>
                {% endif %}
                {% if page * limit < upcount %}
                  <a class="button" href="{{ url('user_management', { page: page + 1, search: search, sort: sort }) }}">下一页 &raquo;</a>
                {% endif %}
              </div>
            </div>
          </td>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>
</div>

<!-- 编辑用户模态框 -->
<div class="modal" id="edit-user-modal">
  <div class="modal-container">
    <div class="modal-header">
      <h3>编辑用户</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="edit-user-form" method="post">
        <input type="hidden" name="uid" id="edit-uid">
        <div class="row">
          <div class="columns small-12">
            <label>显示名称
              <input type="text" name="displayName" id="edit-displayName">
            </label>
          </div>
          <div class="columns small-12 medium-6">
            <label>学号
              <input type="text" name="studentId" id="edit-studentId">
            </label>
          </div>
          <div class="columns small-12 medium-6">
            <label>学校
              <input type="text" name="school" id="edit-school">
            </label>
          </div>
          <div class="columns small-12">
            <label>主页
              <input type="text" name="home" id="edit-home" placeholder="https://example.com">
            </label>
          </div>
          <div class="columns small-12">
            <label>权限
              <input type="text" name="permission" id="edit-permission" placeholder="user,admin">
            </label>
            <p class="help-text">请输入权限标识符，多个权限用逗号分隔</p>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="button" data-close-modal>取消</button>
      <button class="primary button" id="save-user-changes">保存更改</button>
    </div>
  </div>
</div>

<!-- 重置密码模态框 -->
<div class="modal" id="reset-password-modal">
  <div class="modal-container">
    <div class="modal-header">
      <h3>重置密码</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <form id="reset-password-form" method="post">
        <input type="hidden" name="uid" id="reset-uid">
        <div class="row">
          <div class="columns small-12">
            <label>新密码
              <input type="password" name="password" id="new-password" placeholder="请输入新密码">
            </label>
          </div>
          <div class="columns small-12">
            <label>确认密码
              <input type="password" name="confirmPassword" id="confirm-password" placeholder="请再次输入新密码">
            </label>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="button" data-close-modal>取消</button>
      <button class="primary button" id="confirm-reset-password">重置密码</button>
    </div>
  </div>
</div>

<!-- 批量操作工具栏 -->
<div class="section">
  <div class="section__body">
    <div class="row">
      <div class="columns small-12">
        <div class="batch-actions">
          <button class="button" id="batch-delete"><span class="icon icon-trash"></span> 批量删除</button>
          <button class="button" id="batch-enable"><span class="icon icon-check"></span> 批量启用</button>
          <button class="button" id="batch-disable"><span class="icon icon-x"></span> 批量禁用</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 全选/取消全选
    document.getElementById('select-all').addEventListener('change', function(e) {
      const checkboxes = document.querySelectorAll('input[name="uids"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
      });
    });
    
    // 编辑用户
    document.querySelectorAll('.edit-user').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const uid = this.dataset.uid;
        // 这里可以通过AJAX获取用户信息并填充表单
        document.getElementById('edit-uid').value = uid;
        document.getElementById('edit-user-modal').classList.add('active');
      });
    });
    
    // 重置密码
    document.querySelectorAll('.reset-password').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const uid = this.dataset.uid;
        document.getElementById('reset-uid').value = uid;
        document.getElementById('reset-password-modal').classList.add('active');
      });
    });
    
    // 切换用户状态
    document.querySelectorAll('.toggle-user-status').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const uid = this.dataset.uid;
        const status = this.dataset.status;
        if (confirm(status === 'disable' ? '确定要禁用该用户吗？' : '确定要启用该用户吗？')) {
          // 这里可以通过AJAX切换用户状态
          location.reload();
        }
      });
    });
    
    // 删除用户
    document.querySelectorAll('.delete-user').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const uid = this.dataset.uid;
        if (confirm('确定要删除该用户吗？')) {
          // 这里可以通过AJAX删除用户
          location.reload();
        }
      });
    });
    
    // 保存用户编辑
    document.getElementById('save-user-changes').addEventListener('click', function() {
      // 这里可以通过AJAX保存用户信息
      document.getElementById('edit-user-modal').classList.remove('active');
      location.reload();
    });
    
    // 确认重置密码
    document.getElementById('confirm-reset-password').addEventListener('click', function() {
      const password = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      if (password !== confirmPassword) {
          alert('两次输入的密码不匹配');
          return;
        }
      // 这里可以通过AJAX重置密码
      document.getElementById('reset-password-modal').classList.remove('active');
      location.reload();
    });
    
    // 批量删除
    document.getElementById('batch-delete').addEventListener('click', function() {
      const selectedUids = Array.from(document.querySelectorAll('input[name="uids"]:checked')).map(checkbox => checkbox.value);
      if (selectedUids.length === 0) {
        alert('请选择要操作的用户');
        return;
      }
      if (confirm('确定要批量删除选中的用户吗？')) {
        // 这里可以通过AJAX批量删除用户
        location.reload();
      }
    });
    
    // 批量启用
    document.getElementById('batch-enable').addEventListener('click', function() {
      const selectedUids = Array.from(document.querySelectorAll('input[name="uids"]:checked')).map(checkbox => checkbox.value);
      if (selectedUids.length === 0) {
        alert('请选择要操作的用户');
        return;
      }
      // 这里可以通过AJAX批量启用用户
      location.reload();
    });
    
    // 批量禁用
    document.getElementById('batch-disable').addEventListener('click', function() {
      const selectedUids = Array.from(document.querySelectorAll('input[name="uids"]:checked')).map(checkbox => checkbox.value);
      if (selectedUids.length === 0) {
        alert('{{ _('user_management_select_users') }}');
        return;
      }
      // 这里可以通过AJAX批量禁用用户
      location.reload();
    });
    
    // 关闭模态框
    document.querySelectorAll('[data-close-modal]').forEach(button => {
      button.addEventListener('click', function() {
        const modal = this.closest('.modal');
        modal.classList.remove('active');
      });
    });
    
    // 点击模态框外部关闭
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });
  });
</script>
</div>
{% endblock %}