{% import "components/user.html" as user with context %}
{% extends "manage_base.html" %}
{% set has_user = target is defined and target %}
{% block manage_content %}
<div class="section">
  <div class="section__header">
    <h1 class="section__title">{{ _('User Management') }}</h1>
  </div>
  <div class="section__body">
    <form method="get">
      <div class="row align-bottom">
        <div class="medium-9 columns">
          {{ form.form_input({
            label: _('User ID / Username / Email'),
            name: 'keyword',
            value: keyword or '',
            placeholder: _('User ID / Username / Email')
          }) }}
        </div>
        <div class="medium-3 columns">
          <label>&nbsp;</label>
          <button class="rounded primary button" type="submit">{{ _('Load User') }}</button>
        </div>
      </div>
    </form>
    {% if searchError %}
      <div class="callout warning">{{ searchError }}</div>
    {% endif %}
  </div>
</div>
{% if has_user %}
<div class="section">
  <div class="section__header">
    <h1 class="section__title">{{ _('Basic Information') }}</h1>
  </div>
  <div class="section__body no-padding">
    <table class="data-table">
      <tbody>
        <tr>
          <th>{{ _('User ID') }}</th>
          <td>{{ target._id }}</td>
        </tr>
        <tr>
          <th>{{ _('Username') }}</th>
          <td>{{ user.render_inline(target, badge=false) }}</td>
        </tr>
        <tr>
          <th>{{ _('Email') }}</th>
          <td>{{ target.mail }}</td>
        </tr>
        <tr>
          <th>{{ _('Homepage') }}</th>
          <td>
            {% if target.homepage %}
              <a class="typo-a" href="{{ target.homepage }}">{{ target.homepage }}</a>
            {% else %}
              {{ _('Not set') }}
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>{{ _('Privilege') }}</th>
          <td>{{ target.priv }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<div class="section">
  <div class="section__header">
    <h1 class="section__title">{{ _('Update Password') }}</h1>
  </div>
  <div class="section__body">
    <form method="post" action="{{ url('manage_user_admin_password') }}">
      <input type="hidden" name="uid" value="{{ target._id }}">
      {{ form.form_password({ label: _('New Password'), name: 'password' }) }}
      <button class="rounded primary button" type="submit">{{ _('Update Password') }}</button>
    </form>
  </div>
</div>
<div class="section">
  <div class="section__header">
    <h1 class="section__title">{{ _('Update Homepage') }}</h1>
  </div>
  <div class="section__body">
    <form method="post" action="{{ url('manage_user_admin_homepage') }}">
      <input type="hidden" name="uid" value="{{ target._id }}">
      {{ form.form_input({ label: _('Homepage'), name: 'homepage', value: target.homepage or '' }) }}
      <button class="rounded primary button" type="submit">{{ _('Update Homepage') }}</button>
    </form>
  </div>
</div>
<div class="section">
  <div class="section__header">
    <h1 class="section__title">{{ _('Update Privilege') }}</h1>
  </div>
  <div class="section__body">
    <form method="post" action="{{ url('manage_user_admin_priv') }}">
      <input type="hidden" name="uid" value="{{ target._id }}">
      {% set _mark = Math.ceil(privEntries.length / 3) %}
      <div class="row">
        {% for col in range(0, 3) %}
        <div class="medium-4 columns">
          <table class="data-table priv_table">
            <colgroup>
              <col class="col--description">
              <col class="col--p">
            </colgroup>
            <thead>
              <tr>
                <th class="col--description">{{ _('Name') }}</th>
                <th class="col--p">{{ _('Privilege') }}</th>
              </tr>
            </thead>
            <tbody>
              {% for p in privEntries.slice(col * _mark, (col + 1) * _mark) %}
              <tr>
                <td class="col--description">{{ _(p[0]) }}</td>
                <td class="col--p">
                  <label class="compact checkbox">
                    <input class="priv" name="priv" value="{{ p[1] }}" type="checkbox"
                      {% if p[1] in selectedPrivs %}checked{% endif %}>
                  </label>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endfor %}
      </div>
      <div class="row">
        <div class="columns">
          <button class="rounded primary button" type="submit">{{ _('Update Privilege') }}</button>
        </div>
      </div>
    </form>
  </div>
</div>
<div class="section">
  <div class="section__header">
    <h1 class="section__title">{{ _('Domain Permissions') }}</h1>
  </div>
  <div class="section__body no-padding">
    <table class="data-table">
      <colgroup>
        <col class="col--domain">
        <col class="col--role">
        <col class="col--value">
        <col class="col--list">
      </colgroup>
      <thead>
        <tr>
          <th class="col--domain">{{ _('Domain') }}</th>
          <th class="col--role">{{ _('Role') }}</th>
          <th class="col--value">{{ _('Permission Value') }}</th>
          <th class="col--list">{{ _('Permission List') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for record in domainPermissions %}
        <tr>
          <td class="col--domain">{{ record.domainName }}</td>
          <td class="col--role">{{ record.role }}</td>
          <td class="col--value" title="{{ record.permText }}">{{ record.permText }}</td>
          <td class="col--list">
            {% if record.permEntries and record.permEntries.length %}
              <ul>
                {% for perm in record.permEntries %}
                  <li>{{ _(perm) }}</li>
                {% endfor %}
              </ul>
            {% else %}
              {{ _('No permission') }}
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="text-center">{{ _('No joined domain records') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}
